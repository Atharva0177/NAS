# üìÇ NAS (Network Attached Storage)

A self‚Äëhosted, password‚Äëprotected web app to browse, preview, and stream files from your local or mounted drives.

Backend: FastAPI ‚Ä¢ Frontend: Jinja + Vanilla JS

Highlights
- üîë Login protection (signed sessions)
- üìÇ Drive browsing with safe path handling
- üñº Thumbnails for images (and video posters)
- üé¨ Streaming with range requests (seek)
- üîç Search
- üß≠ Clean, responsive UI with list/grid views
- üß© Rich, in‚Äëpopup previews for many file types (see below)

---

## ‚ö° Quick Start

1) Clone
```bash
git clone https://github.com/Atharva0177/NAS.git
cd NAS
```

2) Python env + dependencies
```bash
python3 -m venv .venv
# Windows PowerShell: .\.venv\Scripts\Activate.ps1
source .venv/bin/activate
pip install -r hdd_browser/requirements.txt
```

3) Configure minimal env vars
- Linux/macOS:
```bash
export AUTH_USERNAME=admin
export AUTH_PASSWORD=secret
export SESSION_SECRET=change_this_to_a_long_random_value
```
- Windows PowerShell:
```powershell
setx AUTH_USERNAME admin
setx AUTH_PASSWORD secret
setx SESSION_SECRET change_this_to_a_long_random_value
```

4) Run
```bash
uvicorn hdd_browser.app.main:app --host 0.0.0.0 --port 8080 --reload
```

5) Open
```
http://localhost:8080
```

---

## ‚ú® What‚Äôs New

- In‚Äëpopup viewers (client‚Äëonly, no server plugins):
  - DOCX ‚Üí HTML via Mammoth.js
  - XLSX/XLS/CSV ‚Üí tables via SheetJS (XLSX)
  - JSON/JSO/IPYNB ‚Üí pretty‚Äëprinted JSON
  - XML ‚Üí pretty‚Äëprinted in code modal
  - YAML/YML ‚Üí parsed and re‚Äëdumped with js‚Äëyaml when available
  - TXT/CPP/PY ‚Üí raw code modal
  - PDF ‚Üí embedded inline
- Video: MKV support added in the UI. Playback depends on browser codecs.
- Robust multi‚ÄëCDN loader with optional local vendor fallback for viewer libraries.

---

## üß© File Preview Matrix (Popup)

- Images: jpg, jpeg, png, webp, gif, bmp, heic/heif, avif, tiff
- Videos: mp4, webm, mov, m4v, avi, mkv, ogv/ogg
  - Note: MKV playback depends on the video/audio codecs your browser supports.
- Documents:
  - PDF: embedded inline
  - DOCX: rendered to HTML (Mammoth.js)
  - XLSX/XLS/CSV: rendered as tables (SheetJS)
  - DOC/PPT/PPTX: not supported in‚Äëbrowser; use Open/Download
- Text/Code:
  - json, jso, ipynb (pretty JSON), txt, cpp, py, xml (pretty), yaml/yml (pretty with js‚Äëyaml)

Large text previews are truncated to keep the UI fast:
- Max ~1.5‚ÄØMB raw text
- CSV/TXT inline rendering capped to a safe number of lines

---

## üì¶ Optional: Offline / Air‚Äëgapped Vendor Setup

The app loads client‚Äëviewer libraries from public CDNs by default. To self‚Äëhost them:

1) Create a static vendor folder, for example:
```
hdd_browser/app/static/vendor/libs/
```

2) Download these files into that folder (names shown as expected by the loader if you customize it):
- Mammoth: `mammoth.browser.min.js`
- SheetJS: `xlsx.full.min.js`
- js‚Äëyaml (optional, YAML pretty‚Äëprint): `js-yaml.min.js`

3) In your base template (before `app.js`), set your preferred base if you add a local loader:
```html
<script>window.PPTX_VENDOR_BASE = "/static/vendor/libs/";</script>
```

The loader will try your local files first, then CDNs (if configured that way).

---

## üîß Configuration

You can use environment variables or a `.env` file (auto‚Äëloaded by the app).

Common variables:
- `APP_NAME` ‚Äì UI title
- `HOST`, `PORT` ‚Äì server bind
- `DEBUG` ‚Äì True/False
- `AUTH_USERNAME`, `AUTH_PASSWORD` ‚Äì login credentials
- `SESSION_SECRET` ‚Äì 16+ char secret for signed cookies
- `ENABLE_UPLOAD` ‚Äì True/False
- `ENABLE_DELETE` ‚Äì True/False
- `ENABLE_THUMBNAILS` ‚Äì True/False
- `THUMB_CACHE_DIR` ‚Äì path to thumbnail cache
- `FFMPEG_PATH` ‚Äì override ffmpeg path (video thumbs/posters)
- `ENABLE_HEIC_CONVERSION` ‚Äì True/False
- `ALLOWED_ROOTS` ‚Äì comma‚Äëseparated allowed root directories (limits browsing scope)

Frontend toggles (set via page scripts or template globals):
- `THUMB_MAX_CONC` ‚Äì control thumbnail load concurrency (default 1 for strict serial)

Example `.env`:
```env
APP_NAME=NAS
DEBUG=True
AUTH_USERNAME=admin
AUTH_PASSWORD=secret
SESSION_SECRET=change_me_long_random
ENABLE_UPLOAD=True
ENABLE_DELETE=False
ENABLE_THUMBNAILS=True
THUMB_CACHE_DIR=.thumb_cache
ALLOWED_ROOTS=/mnt/storage,/home
```

---

## üñ• Running in Production

Uvicorn example:
```bash
uvicorn hdd_browser.app.main:app --host 0.0.0.0 --port 8080
```

Systemd unit (example):
```ini
[Unit]
Description=NAS (FastAPI)
After=network.target

[Service]
Type=simple
User=YOUR_USER
WorkingDirectory=/path/to/NAS
Environment=PATH=/path/to/NAS/.venv/bin
ExecStart=/path/to/NAS/.venv/bin/uvicorn hdd_browser.app.main:app --host 0.0.0.0 --port 8080
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

---

## üåê Remote Access with Tailscale (Windows, macOS, Linux)

Tailscale gives you a private, encrypted network between your devices. You can access your NAS UI from anywhere without port‚Äëforwarding.

### A. Install & Sign In

- Download and install [Tailscale](https://tailscale.com/download) on your NAS and client devices.
- Sign in with the same account on all devices.
- On the NAS, verify it‚Äôs connected:
```powershell
# Windows PowerShell
& "C:\Program Files\Tailscale\tailscale.exe" status
& "C:\Program Files\Tailscale\tailscale.exe" ip -4
```
You should see a 100.x.x.x Tailscale IP (and a `.ts.net` MagicDNS name if enabled).

### B. Run NAS and bind to all interfaces

Start NAS:
```bash
uvicorn hdd_browser.app.main:app --host 0.0.0.0 --port 8080
```

Optional (Windows Firewall): allow inbound on 8080 for local/LAN use
```powershell
New-NetFirewallRule -DisplayName "NAS 8080" -Direction Inbound -Protocol TCP -LocalPort 8080 -Action Allow
```

### C. Access over Tailscale

- From another device on your tailnet:
  - With MagicDNS off: `http://<tailscale-ip>:8080`
  - With MagicDNS on (Admin Console ‚Üí DNS ‚Üí MagicDNS): `http://<device-name>.tailnet-name.ts.net:8080`

Tips
- Set `DEBUG=False` for remote access.
- Use strong `AUTH_USERNAME`, `AUTH_PASSWORD`, and a long `SESSION_SECRET`.

---

## üåç Public Internet Access via Tailscale Funnel (Windows)

Tailscale Funnel can publish your local NAS to the public Internet under an HTTPS `.ts.net` domain, without router or DNS changes.

Prerequisites
- Tailscale v1.54+ on Windows (CLI installed at `C:\Program Files\Tailscale\tailscale.exe`)
- Funnel feature enabled for your tailnet (Admin Console ‚Üí Settings ‚Üí Funnel)
- MagicDNS and HTTPS certs enabled (Admin Console ‚Üí DNS ‚Üí check ‚ÄúMagicDNS‚Äù; and in the device‚Äôs Machine page, allow HTTPS certs if prompted)

1) Start the NAS locally
```powershell
# In your NAS folder (PowerShell)
.\.venv\Scripts\Activate.ps1
uvicorn hdd_browser.app.main:app --host 127.0.0.1 --port 8080
```

2) Configure Tailscale Serve (reverse proxy) to your NAS
Use the new Serve syntax (preferred on recent Tailscale versions):
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" serve https / http://127.0.0.1:8080
```
This sets up an HTTPS reverse proxy from the device‚Äôs `.ts.net` name to your local NAS.

3) Turn on Funnel (expose to the public Internet)
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" funnel 443 on
```

4) Verify status and URL
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" serve status
```
You should see a public URL like:
```
https://<your-device>.<your-tailnet>.ts.net/
```
Open it from any browser on the Internet. Tailscale provisions a valid Let‚Äôs Encrypt certificate automatically.

Notes
- If `funnel` fails: ensure Funnel is enabled in the Admin Console and update to the latest Tailscale client. You may need admin rights in PowerShell.
- Fullscreen or other advanced UI features are unrelated; Funnel only handles public routing and TLS.
- To disable Funnel later:
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" funnel 443 off
```
- To remove the Serve mapping:
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" serve reset
```

Alternative (older syntax)
Some older versions use set‚Äëpath:
```powershell
& "C:\Program Files\Tailscale\tailscale.exe" serve --set-path / http://127.0.0.1:8080
& "C:\Program Files\Tailscale\tailscale.exe" funnel on
```

Custom domain?
- Funnel serves on your `.ts.net` name. For a custom domain, place a traditional reverse proxy (e.g., nginx/traefik) in front of your NAS or use a different tunneling provider that supports custom DNS on Windows.

---

## üß∞ Run NAS as a Windows Service (optional)

Use [NSSM](https://nssm.cc/) (Non‚ÄëSucking Service Manager) to run Uvicorn as a service:

1) Install NSSM and open an elevated PowerShell
2) Create the service:
```powershell
nssm install NAS
# GUI:
# Application: C:\Path\To\NAS\.venv\Scripts\uvicorn.exe
# Arguments:   hdd_browser.app.main:app --host 127.0.0.1 --port 8080
# Startup dir: C:\Path\To\NAS
```
3) Set environment variables in the NSSM ‚ÄúEnvironment‚Äù field or via System ‚Üí Advanced ‚Üí Environment Variables
4) Start the service:
```powershell
nssm start NAS
```
Pair with Tailscale Serve + Funnel as above to publish it.

---

## üîí Security

- Only public paths (`/auth/login`, `/static/*`) are open; everything else requires a valid session.
- Session cookies are signed (`itsdangerous`); provide a long `SESSION_SECRET`.
- Path traversal is blocked via safe path joining.

---

## üì° API (Authenticated)

Key endpoints:
- `GET /api/drives` ‚Äì list drives
- `GET /api/list?drive_id&rel_path` ‚Äì list directory contents
- `GET /api/preview?drive_id&rel_path` ‚Äì light preview/metadata
- `GET /api/download?drive_id&rel_path` ‚Äì download a file
- `GET /api/stream?drive_id&rel_path` ‚Äì range‚Äëenabled streaming (audio/video)
- `GET /api/search?drive_id&q` ‚Äì recursive search
- `POST /api/upload` ‚Äì upload file(s) (if enabled)
- `POST /api/delete` ‚Äì delete file/folder (if enabled; folder can be recursive)
- `GET /api/thumb?drive_id&rel_path&size=...` ‚Äì thumbnail
- `GET /api/render_image?drive_id&rel_path&max_dim=...` ‚Äì server‚Äësized image

---

## üß† Tips

- Use `ALLOWED_ROOTS` to confine browsing to specific folders.
- For HEIC images, ensure `pillow-heif` is installed (already in requirements).
- Video thumbnails/posters need `ffmpeg` available in PATH (or set `FFMPEG_PATH`).
- If you‚Äôre air‚Äëgapped, self‚Äëhost the viewer libraries and set a local vendor base.

---

## üß± Project Structure (simplified)

```
NAS/
‚îú‚îÄ hdd_browser/
‚îÇ  ‚îú‚îÄ app/
‚îÇ  ‚îÇ  ‚îú‚îÄ main.py               # FastAPI app entry
‚îÇ  ‚îÇ  ‚îú‚îÄ auth.py               # login/session
‚îÇ  ‚îÇ  ‚îú‚îÄ config.py             # env & settings
‚îÇ  ‚îÇ  ‚îú‚îÄ security.py           # public/private path rules
‚îÇ  ‚îÇ  ‚îú‚îÄ drive_discovery.py    # drive/mount detection
‚îÇ  ‚îÇ  ‚îú‚îÄ file_ops.py           # core file operations
‚îÇ  ‚îÇ  ‚îú‚îÄ thumbnailer.py        # thumbs/posters
‚îÇ  ‚îÇ  ‚îú‚îÄ heic_init.py          # HEIC support
‚îÇ  ‚îÇ  ‚îú‚îÄ templates/            # Jinja2 templates
‚îÇ  ‚îÇ  ‚îî‚îÄ static/
‚îÇ  ‚îÇ     ‚îú‚îÄ css/
‚îÇ  ‚îÇ     ‚îî‚îÄ js/                # frontend (viewers & UI)
‚îÇ  ‚îî‚îÄ requirements.txt
‚îî‚îÄ README.md
```

---

## ‚ö†Ô∏è Known Limitations

- PowerPoint formats (PPT/PPTX) are not supported in‚Äëbrowser; use Open/Download.
- MKV playback depends on your browser‚Äôs codec support.
- Very large text/CSV files are truncated in preview for performance.

---

## üìÑ License

This project is licensed under the [MIT License](LICENSE).
